openapi: 3.0.0
info:
  title: API Assinador Digital ICP-Brasil
  description: |
    API profissional para assinatura digital de PDFs (PAdES), conversão para PDF/A e processamento em lote.
    
    **Conformidade ICP-Brasil:**
    Esta API implementa validações rigorosas de segurança nos certificados digitais, incluindo:
    * Verificação de Data de Validade (NotBefore / NotAfter).
    * Verificação de Tamanho de Chave (Mínimo 2048 bits).
    * Verificação de Algoritmo de Assinatura (Exige SHA-256 ou superior).
  version: 1.1.0
  contact:
    name: Equipe de Desenvolvimento
    email: dev@assinador.com.br

servers:
  - url: http://localhost:3000
    description: Servidor Local (Dev)

paths:
  /:
    get:
      summary: Health Check
      description: Verifica se a API está online.
      responses:
        200:
          description: API Online
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "Online"
                  message:
                    type: string

  /api/v1/sign:
    post:
      summary: Assinar PDF Individual
      description: |
        Recebe um PDF e um Certificado A1 (.pfx) e retorna o PDF assinado digitalmente.
        
        **Validações:** Antes de assinar, o sistema verifica se o certificado é válido, se possui chave RSA de no mínimo 2048 bits e se utiliza algoritmo SHA-256, conforme normas da ICP-Brasil.
      tags:
        - Assinatura
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                pdf:
                  type: string
                  format: binary
                  description: Arquivo PDF original.
                certificate:
                  type: string
                  format: binary
                  description: Arquivo do certificado digital (.pfx ou .p12).
                password:
                  type: string
                  description: Senha do certificado.
                page:
                  type: integer
                  description: "(Opcional) Número da página para o carimbo visual. Padrão: Última."
                x:
                  type: integer
                  description: "(Opcional) Posição X do carimbo."
                y:
                  type: integer
                  description: "(Opcional) Posição Y do carimbo (0 = Rodapé)."
      responses:
        200:
          description: PDF Assinado com sucesso.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        400:
          description: |
            Erro de validação ou segurança. Possíveis causas:
            * Senha incorreta.
            * Certificado expirado ou ainda não válido.
            * Chave privada fraca (menor que 2048 bits).
            * Algoritmo de assinatura inseguro (ex: SHA-1).
            * Arquivo PDF inválido ou corrompido.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "error"
                  message:
                    type: string
                    example: "O certificado possui uma chave de 1024 bits. A norma ICP-Brasil exige no mínimo 2048 bits."

  /api/v1/sign/preview:
    post:
      summary: Preview de Página
      description: Extrai uma página específica do PDF para visualização prévia ou retorna o documento todo. Útil para o frontend posicionar o carimbo.
      tags:
        - Utilitários
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                pdf:
                  type: string
                  format: binary
                  description: Arquivo PDF para visualizar.
                page:
                  type: integer
                  description: "(Opcional) Número da página. Se omitido, retorna o PDF completo."
      responses:
        200:
          description: PDF contendo a página solicitada.
          content:
            application/pdf:
              schema:
                type: string
                format: binary

  /api/v1/sign/batch:
    post:
      summary: Assinatura em Lote
      description: |
        Assina múltiplos PDFs de uma vez com o mesmo certificado e retorna um arquivo ZIP.
        
        **Segurança:** O certificado é validado uma única vez antes do início do processamento. Se for inválido (expirado ou fraco), a operação é abortada imediatamente para evitar processamento inútil.
      tags:
        - Assinatura
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                certificate:
                  type: string
                  format: binary
                  description: Arquivo do certificado digital (.pfx).
                password:
                  type: string
                  description: Senha do certificado.
                pdfs:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Lista de arquivos PDF para assinar (máx 20 recomendado).
                x:
                  type: integer
                  description: (Opcional) Posição X para todos os arquivos.
                y:
                  type: integer
                  description: (Opcional) Posição Y para todos os arquivos.
      responses:
        200:
          description: Arquivo ZIP contendo os PDFs assinados e eventuais logs de erro de arquivos individuais.
          content:
            application/zip:
              schema:
                type: string
                format: binary
        400:
          description: Erro crítico de validação do certificado (Expiração, Senha ou Segurança).

  /api/v1/convert/pdfa:
    post:
      summary: Converter para PDF/A
      description: Converte um PDF padrão para o formato PDF/A-1b (Arquivamento de Longo Prazo) usando Ghostscript.
      tags:
        - Utilitários
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                pdf:
                  type: string
                  format: binary
                  description: Arquivo PDF original.
      responses:
        200:
          description: PDF convertido e validado estruturalmente.
          content:
            application/pdf:
              schema:
                type: string
                format: binary