openapi: 3.0.0
info:
  title: API de Assinatura Digital e Processamento PDF (ICP-Brasil)
  description: |
    Documentação técnica da API de microsserviços para manipulação de documentos PDF.
    
    ### Stack Tecnológica
    * **Runtime:** Node.js (TypeScript)
    * **Processamento PDF:** PDF-Lib & Ghostscript (para conformidade PDF/A)
    * **Criptografia:** Node-Forge (PKI.js logic) & Node-SignPDF
    * **Segurança:** Processamento de chaves privadas estritamente em memória (RAM), sem persistência em disco.

    ### Padrões Suportados
    * **Assinatura:** PAdES-Basic (PDF Advanced Electronic Signatures).
    * **Certificados:** X.509 via containers PKCS#12 (.pfx/.p12).
    * **Hash:** SHA-256 (Enforced via `PfxParserService` para compliance ICP-Brasil).
    * **Chaves:** RSA 2048-bit ou superior.
    * **Arquivamento:** PDF/A-1b (ISO 19005-1).

  version: 2.0.0

servers:
  - url: hhttps://assinador-digital.api.ioshuavps.com.br/api/v1
    description: Ambiente de Produção
  - url: http://localhost:3000
    description: Ambiente de Desenvolvimento (Local)

tags:
  - name: Signer
    description: Endpoints para assinatura digital (PAdES) e carimbos visuais.
  - name: Converter
    description: Endpoints para normalização e conversão de normas (PDF/A).

paths:
  /sign/:
    post:
      summary: Assinar PDF (Single Transaction)
      description: |
        Realiza a assinatura digital de um único documento PDF utilizando um certificado A1.
        
        **Fluxo de Processamento:**
        1. Upload do PDF e Certificado para memória volátil (Buffer).
        2. Validação criptográfica do certificado (Cadeia, Validade, Key Usage, Algoritmo).
        3. Aplicação do carimbo visual (se coordenadas fornecidas).
        4. Injeção da assinatura PAdES (ByteRange manipulado).
        5. Retorno do binário assinado.
      tags:
        - Signer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - pdf
                - certificate
                - password
              properties:
                pdf:
                  type: string
                  format: binary
                  description: Arquivo PDF original (Max 10MB).
                certificate:
                  type: string
                  format: binary
                  description: Container PKCS#12 (.pfx ou .p12).
                password:
                  type: string
                  format: password
                  description: Senha de descriptografia da chave privada.
                page:
                  type: integer
                  description: "Índice da página para o carimbo visual (1-based). Default: Última página."
                  example: 1
                x:
                  type: number
                  description: "Coordenada X (pontos) do carimbo visual."
                  example: 100
                y:
                  type: number
                  description: "Coordenada Y (pontos) do carimbo visual."
                  example: 50
                width:
                  type: number
                  description: "Largura do carimbo visual."
                  default: 300
                height:
                  type: number
                  description: "Altura do carimbo visual."
                  default: 60
      responses:
        200:
          description: Sucesso. Retorna o binário do PDF assinado.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        400:
          $ref: '#/components/responses/BadRequest'
        500:
          $ref: '#/components/responses/ServerError'

  /sign/batch:
    post:
      summary: Assinatura em Lote (Batch Processing)
      description: |
        Processa múltiplos PDFs utilizando uma única validação de certificado.
        Retorna um arquivo ZIP contendo os documentos assinados e logs de erro individuais (se houver).
        
        **Performance:** O certificado é descriptografado e validado apenas uma vez antes da iteração sobre os arquivos.
      tags:
        - Signer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - pdfs
                - certificate
                - password
              properties:
                certificate:
                  type: string
                  format: binary
                  description: Container PKCS#12 (.pfx).
                password:
                  type: string
                  format: password
                pdfs:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: 'Array de arquivos PDF. (Sugestão: Max 20 arquivos/req).'
                x:
                  type: number
                  description: Coordenada X global para todos os arquivos.
                y:
                  type: number
                  description: Coordenada Y global para todos os arquivos.
      responses:
        200:
          description: Arquivo ZIP contendo os resultados.
          content:
            application/zip:
              schema:
                type: string
                format: binary
        400:
          $ref: '#/components/responses/BadRequest'

  /sign/preview:
    post:
      summary: Extração de Página (Preview)
      description: |
        Utilitário para extrair uma página específica de um PDF. 
        Utilizado pelo frontend para renderizar um canvas onde o usuário escolhe a posição do carimbo visual (X, Y).
      tags:
        - Signer
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - pdf
              properties:
                pdf:
                  type: string
                  format: binary
                page:
                  type: integer
                  description: "Número da página a ser extraída (1-based). Se omitido, retorna o doc todo."
      responses:
        200:
          description: PDF contendo apenas a página solicitada.
          content:
            application/pdf:
              schema:
                type: string
                format: binary

  /convert/pdfa:
    post:
      summary: Conversão PDF/A-1b (Ghostscript)
      description: |
        Converte um PDF arbitrário para o padrão ISO 19005-1 (PDF/A-1b).
        
        **Processo:**
        1. Sanitização de inputs.
        2. Injeção de perfil de cor ICC (sRGB).
        3. Execução de subprocesso Ghostscript com flags `-dPDFA=1`.
        4. Validação de metadados XMP.
      tags:
        - Converter
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - pdf
              properties:
                pdf:
                  type: string
                  format: binary
      responses:
        200:
          description: Documento convertido em conformidade PDF/A.
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        500:
          description: Falha na conversão (Erro Ghostscript).
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorPayload'

components:
  schemas:
    ErrorPayload:
      type: object
      properties:
        status:
          type: string
          example: "error"
        message:
          type: string
          example: "O certificado expirou em 2025-12-31."

  responses:
    BadRequest:
      description: Erro de Validação (Regra de Negócio ou Input)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorPayload'
    
    ServerError:
      description: Erro Interno do Servidor (Unhandled Exception)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorPayload'